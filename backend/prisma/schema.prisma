generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  userId                                Int                 @id @default(autoincrement())
  username                              String
  email                                 String              @unique
  phoneNumber                           String?             @unique
  passwordHash                          String?
  googleId                              String?             @unique
  profileImg                            String?
  isActive                              Boolean             @default(true)
  createdAt                             DateTime            @default(now())
  updatedAt                             DateTime
  group_expense_splits                  GroupExpenseSplit[]
  group_expenses                        GroupExpense[]
  group_memberships                     group_memberships[]
  groups                                Group[]
  invitations                           Invitation[]
  notifications                         Notification[]
  personal_expenses                     PersonalExpense[]
  sessions                              Session[]
  settlements_settlements_paidByTousers Settlement[]        @relation("settlements_paidByTousers")
  settlements_settlements_paidToTousers Settlement[]        @relation("settlements_paidToTousers")

  @@map("users")
}

model Session {
  sessionId    Int      @id @default(autoincrement())
  userId       Int
  refreshToken String
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  users        User     @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@map("sessions")
}

model Group {
  groupId           Int                 @id @default(autoincrement())
  groupName         String
  createdBy         Int
  isDeleted         Boolean             @default(false)
  createdAt         DateTime            @default(now())
  group_expenses    GroupExpense[]
  group_memberships group_memberships[]
  users             User                @relation(fields: [createdBy], references: [userId])
  invitations       Invitation[]
  notifications     Notification[]
  settlements       Settlement[]

  @@map("groups")
}

model Invitation {
  invitationId Int      @id @default(autoincrement())
  groupId      Int
  invitedPhone String
  invitedBy    Int
  status       String   @default("pending")
  createdAt    DateTime @default(now())
  groups       Group    @relation(fields: [groupId], references: [groupId], onDelete: Cascade)
  users        User     @relation(fields: [invitedBy], references: [userId])

  @@map("invitations")
}

model GroupExpense {
  expenseId            Int                 @id @default(autoincrement())
  groupId              Int
  paidBy               Int
  title                String
  description          String?
  amount               Decimal             @db.Decimal(10, 2)
  splitType            String              @default("equal")
  isDeleted            Boolean             @default(false)
  createdAt            DateTime            @default(now())
  group_expense_splits GroupExpenseSplit[]
  groups               Group               @relation(fields: [groupId], references: [groupId], onDelete: Cascade)
  users                User                @relation(fields: [paidBy], references: [userId])
  settlements          Settlement[]

  @@map("group_expenses")
}

model GroupExpenseSplit {
  splitId        Int          @id @default(autoincrement())
  expenseId      Int
  userId         Int
  shareAmount    Decimal      @db.Decimal(10, 2)
  isSettled      Boolean      @default(false)
  group_expenses GroupExpense @relation(fields: [expenseId], references: [expenseId], onDelete: Cascade)
  users          User         @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@unique([expenseId, userId])
  @@map("group_expense_splits")
}

model PersonalExpense {
  personalExpenseId Int      @id @default(autoincrement())
  userId            Int
  title             String
  description       String?
  amount            Decimal  @db.Decimal(10, 2)
  category          String?
  createdAt         DateTime @default(now())
  users             User     @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@map("personal_expenses")
}

model Settlement {
  settlementId                    Int           @id @default(autoincrement())
  groupId                         Int
  paidBy                          Int
  paidTo                          Int
  amount                          Decimal       @db.Decimal(10, 2)
  
  expenseId                       Int?
  createdAt                       DateTime      @default(now())
  isCompleted                     Boolean?      @default(false) @map("is_completed")
  group_expenses                  GroupExpense? @relation(fields: [expenseId], references: [expenseId])
  groups                          Group         @relation(fields: [groupId], references: [groupId], onDelete: Cascade)
  users_settlements_paidByTousers User          @relation("settlements_paidByTousers", fields: [paidBy], references: [userId])
  users_settlements_paidToTousers User          @relation("settlements_paidToTousers", fields: [paidTo], references: [userId])

  @@map("settlements")
}

model Notification {
  notificationId Int      @id @default(autoincrement())
  userId         Int
  groupId        Int?
  type           String
  message        String
  isRead         Boolean  @default(false)
  createdAt      DateTime @default(now())
  groups         Group?   @relation(fields: [groupId], references: [groupId])
  users          User     @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@map("notifications")
}

model group_memberships {
  membershipId Int      @id @default(autoincrement())
  userId       Int
  groupId      Int
  role         String   @default("member")
  isActive     Boolean  @default(true)
  joinedAt     DateTime @default(now())
  groups       Group    @relation(fields: [groupId], references: [groupId], onDelete: Cascade)
  users        User     @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@unique([userId, groupId])
}
